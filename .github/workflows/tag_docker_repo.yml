name: Tag Docker Repository

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  tag-docker-repo:
    runs-on: ubuntu-24.04
    steps:
      - name: Extract version from tag
        id: version
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "docker_tag=v${TAG_NAME}+0" >> $GITHUB_OUTPUT

      - name: Push tag to Docker repository
        env:
          DOCKER_REPO_TOKEN: ${{ secrets.DOCKER_REPO_TOKEN }}
          DOCKER_REPO: ${{ vars.DOCKER_REPO || 'rspamd/rspamd-docker' }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git clone https://x-access-token:${DOCKER_REPO_TOKEN}@github.com/${DOCKER_REPO}.git
          cd $(basename ${DOCKER_REPO})

          git tag "${{ steps.version.outputs.docker_tag }}"
          git push origin "${{ steps.version.outputs.docker_tag }}"

          echo "Successfully pushed tag ${{ steps.version.outputs.docker_tag }} to ${DOCKER_REPO}"
