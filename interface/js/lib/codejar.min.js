/*!
 * CodeJar 4.3.0 (https://github.com/antonmedv/codejar)
 * Copyright (c) 2020, Anton Medvedev, MIT
 */
let globalWindow=window;function CodeJar(c,n,e={}){let f={tab:"\t",indentOn:/[({\[]$/,moveToNewLine:/^[)}\]]/,spellcheck:!1,catchTab:!0,preserveIdent:!0,addClosing:!0,history:!0,window:globalWindow,autoclose:{open:`([{'"`,close:`)]}'"`},...e},o=f.window,u=o.document,r=[],p=[],h=-1,a=!1,i=()=>{},g,d=(c.setAttribute("contenteditable","plaintext-only"),c.setAttribute("spellcheck",f.spellcheck?"true":"false"),c.style.outline="none",c.style.overflowWrap="break-word",c.style.overflowY="auto",c.style.whiteSpace="pre-wrap",(e,t)=>{n(e,t)});e=o.navigator.userAgent.match(/Firefox\/([0-9]+)\./),e=e?parseInt(e[1]):0;let v=!1,t=((v="plaintext-only"!==c.contentEditable||136<=e?!0:v)&&c.setAttribute("contenteditable","true"),A(()=>{var e=m();d(c,e),C(e)},30)),y=!1,N=e=>!O(e)&&!M(e)&&"Meta"!==e.key&&"Control"!==e.key&&"Alt"!==e.key&&!e.key.startsWith("Arrow"),s=A(e=>{N(e)&&(x(),y=!1)},300);e=(e,t)=>{r.push([e,t]),c.addEventListener(e,t)};function m(){var e=K();let t={start:0,end:0,dir:void 0},{anchorNode:n,anchorOffset:r,focusNode:o,focusOffset:a}=e;if(n&&o)return n===c&&o===c?(t.start=0<r&&c.textContent?c.textContent.length:0,t.end=0<a&&c.textContent?c.textContent.length:0,t.dir=a>=r?"->":"<-"):(n.nodeType===Node.ELEMENT_NODE&&(e=u.createTextNode(""),n.insertBefore(e,n.childNodes[r]),n=e,r=0),o.nodeType===Node.ELEMENT_NODE&&(e=u.createTextNode(""),o.insertBefore(e,o.childNodes[a]),o=e,a=0),w(c,e=>{if(e===n&&e===o)return t.start+=r,t.end+=a,t.dir=r<=a?"->":"<-","stop";if(e===n){if(t.start+=r,t.dir)return"stop";t.dir="->"}else if(e===o){if(t.end+=a,t.dir)return"stop";t.dir="<-"}e.nodeType===Node.TEXT_NODE&&("->"!=t.dir&&(t.start+=e.nodeValue.length),"<-"!=t.dir)&&(t.end+=e.nodeValue.length)}),c.normalize()),t;throw"error1"}function C(n){var e=K();let r,o=0,a,i=0,d=(n.dir||(n.dir="->"),n.start<0&&(n.start=0),n.end<0&&(n.end=0),"<-"==n.dir&&({start:t,end:s}=n,n.start=s,n.end=t),0);w(c,e=>{var t;if(e.nodeType===Node.TEXT_NODE)return t=(e.nodeValue||"").length,d+t>n.start&&(r||(r=e,o=n.start-d),d+t>n.end)?(a=e,i=n.end-d,"stop"):void(d+=t)}),r||(r=c,o=c.childNodes.length),a||(a=c,i=c.childNodes.length),"<-"==n.dir&&([r,o,a,i]=[a,i,r,o]);var t,s=l(r),s=(s&&(t=u.createTextNode(""),s.parentNode?.insertBefore(t,s),r=t,o=0),l(a));s&&(t=u.createTextNode(""),s.parentNode?.insertBefore(t,s),a=t,i=0),e.setBaseAndExtent(r,o,a,i),c.normalize()}function l(e){for(;e&&e!==c;){if(e.nodeType===Node.ELEMENT_NODE){var t=e;if("false"==t.getAttribute("contenteditable"))return t}e=e.parentNode}}function T(){var e=K().getRangeAt(0),t=u.createRange();return t.selectNodeContents(c),t.setEnd(e.startContainer,e.startOffset),t.toString()}function b(){var e=K().getRangeAt(0),t=u.createRange();return t.selectNodeContents(c),t.setStart(e.endContainer,e.endOffset),t.toString()}function E(e){v&&"Enter"===e.key&&(H(e),e.stopPropagation(),""==b()?(S("\n "),(e=m()).start=--e.end,C(e)):S("\n"))}function x(){var e,t,n;a&&(e=c.innerHTML,t=m(),(n=p[h])&&n.html===e&&n.pos.start===t.start&&n.pos.end===t.end||(h++,p[h]={html:e,pos:t},p.splice(h+1),300<h&&(h=300,p.splice(0,1))))}function w(e,t){var n=[];e.firstChild&&n.push(e.firstChild);let r=n.pop();for(;r&&"stop"!==t(r);)r.nextSibling&&n.push(r.nextSibling),r.firstChild&&n.push(r.firstChild),r=n.pop()}function k(e){return e.metaKey||e.ctrlKey}function O(e){return k(e)&&!e.shiftKey&&"Z"===L(e)}function M(e){return k(e)&&e.shiftKey&&"Z"===L(e)}function L(e){e=e.key||e.keyCode||e.which;if(e)return("string"==typeof e?e:String.fromCharCode(e)).toUpperCase()}function S(e){e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),u.execCommand("insertHTML",!1,e)}function A(t,n){let r=0;return(...e)=>{clearTimeout(r),r=o.setTimeout(()=>t(...e),n)}}function D(e){let t=e.length-1;for(;0<=t&&"\n"!==e[t];)t--;let n=++t;for(;n<e.length&&/[ \t]/.test(e[n]);)n++;return[e.substring(t,n)||"",t,n]}function B(){return c.textContent||""}function H(e){e.preventDefault()}function K(){return c.getRootNode().getSelection()}return e("keydown",e=>{if(!e.defaultPrevented){if(g=B(),f.preserveIdent){var t=e;if("Enter"===t.key){var n=T(),r=b(),[o]=D(n);let e=o;f.indentOn.test(n)&&(e+=f.tab),0<e.length?(H(t),t.stopPropagation(),S("\n"+e)):E(t),e!==o&&f.moveToNewLine.test(r)&&(n=m(),S("\n"+o),C(n))}}else E(e);if(f.catchTab){t=e;"Tab"===t.key&&(H(t),t.shiftKey?([t,r]=D(T()),0<t.length&&(o=m(),t=Math.min(f.tab.length,t.length),C({start:r,end:r+t}),u.execCommand("delete"),o.start-=t,o.end-=t,C(o))):S(f.tab))}if(f.addClosing){var a,n=e,i=f.autoclose.open,d=f.autoclose.close;i.includes(n.key)&&(H(n),a=m(),s=a.start==a.end?"":K().toString(),S(n.key+s+(d[i.indexOf(n.key)]??"")),a.start++,a.end++,C(a))}var s,l;f.history&&(O(s=e)&&(H(s),h--,(l=p[h])&&(c.innerHTML=l.html,C(l.pos)),h<0)&&(h=0),M(s)&&(H(s),h++,(l=p[h])&&(c.innerHTML=l.html,C(l.pos)),h>=p.length)&&h--,N(e))&&!y&&(x(),y=!0),v&&(!k(d=e)||"C"!==L(d))&&C(m())}}),e("keyup",e=>{e.defaultPrevented||e.isComposing||(g!==B()&&t(),s(e),i(B()))}),e("focus",e=>{a=!0}),e("blur",e=>{a=!1}),e("paste",e=>{var t;x(),(e=e).defaultPrevented||(H(e),e=(e.originalEvent??e).clipboardData.getData("text/plain").replace(/\r\n?/g,"\n"),t=m(),S(e),d(c),C({start:Math.min(t.start,t.end)+e.length,end:Math.min(t.start,t.end)+e.length,dir:"<-"})),x(),i(B())}),e("cut",e=>{var t,n;x(),e=e,t=m(),n=K(),(e.originalEvent??e).clipboardData.setData("text/plain",n.toString()),u.execCommand("delete"),d(c),C({start:Math.min(t.start,t.end),end:Math.min(t.start,t.end),dir:"<-"}),H(e),x(),i(B())}),{updateOptions(e){Object.assign(f,e)},updateCode(e,t=!0){c.textContent=e,d(c),t&&i(e)},onUpdate(e){i=e},toString:B,save:m,restore:C,recordHistory:x,destroy(){for(var[e,t]of r)c.removeEventListener(e,t)}}}